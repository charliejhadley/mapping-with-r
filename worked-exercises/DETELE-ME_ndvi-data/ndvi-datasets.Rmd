---
title: "NDVI Datasets"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("MODISTools")
library("raster")
library("stars")
library("tidyverse")
library("rnaturalearthdata")
library("sf")
library("mapview")
```

# MODISTools

[MODISTools](https://github.com/ropensci/MODISTools) provides access to lots of data.

... and it just doesn't work.

```{r}
products <- mt_products()
arcachon_lc <- mt_subset(product = "MCD12Q1",
  lat = 44.656286,
  lon =  -1.174748,
  band = "LC_Type1",
  start = "2004-01-01",
  end = "2004-3-20",
  km_lr = 20,
  km_ab = 20,
  site_name = "arcachon",
  internal = TRUE,
  progress = FALSE)
```

# raster to stars

This is a good blogpost: https://bedatablog.netlify.app/post/download-and-illustrate-current-and-projected-climate-in-r/

And another https://www.benjaminbell.co.uk/2018/01/extracting-data-and-making-climate-maps.html

## Past Climate Data

We've got the "bio" var as it includes all 19 climate variables, which I believe are documented here: https://developers.google.com/earth-engine/datasets/catalog/WORLDCLIM_V1_BIO#bands

```{r}
rasters_world_clim <- getData('worldclim', var='bio', res=10)
```

In the {raster} object each of these variables is a name:

```{r}
names(rasters_world_clim)
```

We can convert this to a {stars} object

```{r}
stars_world_clim <- rasters_world_clim %>% 
  st_as_stars()

class(stars_world_clim)
```

We can get its dimensions.. which gives a summary

```{r}
st_dimensions(stars_world_clim)
```

The climate variables are no longer "names" in the object but "bands"! We have 19 of them.

```{r}
names(stars_world_clim)
```


Need to be able to extract the *names* of the bands, which are called values in the object

```{r}
st_get_dimension_values(stars_world_clim, "band")
```

- they can be extracted with slice... but remember it only summaries the first 100,000 cells!!

```{r}
stars_world_clim %>% 
  slice(band, 1)
```
- can they be filtered by the band name:

```{r}
stars_world_clim_bio1 <- stars_world_clim %>% 
  filter(band == "bio1")
```

Can we visualise directly?

```{r}
stars_world_clim %>% 
  filter(band == "bio1") %>% 
  mapview()
```

## Combining with shapefiles

```{r}
countries_sf <- countries110 %>% 
  st_as_sf()
```

```{r}
uk_sf <- countries_sf %>% 
  filter(name == "United Kingdom")
```

This works:

```{r}
stars_world_clim_bio1[uk_sf] %>% 
  mapview()
```


```{r}
stars_uk_temps <- stars_world_clim_bio1 %>% 
  st_intersects(uk_sf)
stars_uk_temps %>% 
  mapview()
```

## Computing on multiple bands

Can I compute on two bands at the same time? bio13 (Precipitation of wettest month) and bio14 (Precipitation of driest month)

```{r}
bio13 <- stars_world_clim %>% 
  filter(band == "bio13") 

bio14 <- stars_world_clim %>% 
  filter(band == "bio14") 

combined_wet_months <- st_join(bio13, bio14)

combined_wet_months$diff <- combined_wet_months$bio1 - combined_wet_months$bio14
```


```{r}
wet_month_diff = function(x) diff(c(x[14], x[13]))
stars_wet_diff <- st_apply(stars_world_clim, c("x", "y"), wet_month_diff)
```

```{r}
stars_wet_diff[uk_sf] %>% 
  mapview()
```


## Future Climate Data

This gets predictions:

- rcp (Radiative Concentration Pathway): different models described briefly on [Wikipedia](https://en.wikipedia.org/wiki/Representative_Concentration_Pathway)... 4.5 assumes peak emissions around 2040

- model: the ‘IPSL-CM5A-LR’ model

- year: can only be 50 or 70

```{r}
rasters_future_clim <- getData(name = 'CMIP5', 
                               var = 'bio', res = 10,
                               rcp = 45, 
                               model = 'IP', 
                               year = 70)
```

```{r}
stars_future_clim <- rasters_future_clim %>% 
  st_as_stars()
```

So this has 19 variables too, which I'm going to assume are the same?


```{r}
stars_world_clim_bio1 %>% 
  st_join(uk_sf)
```


```{r}
stars_world_clim_bio19_16[south_america_sf] %>% 
  mapview()
```


I think bands are months?!

```{r}
ggplot() +
  geom_stars(data = stars_world_clim)
```

## NDVI Data Example

https://github.com/michaeldorman/R_2019/blob/master/06-lesson_06.Rmd uses Israel.

## Time Example

https://r-spatial.github.io/stars/ hurricane





